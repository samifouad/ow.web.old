<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Officer Watch</title>

    <script src="https://storageapi.fleek.co/57985936-9b65-40c9-a41c-ee4de00672af-bucket/js/web3.min.js"></script>

</head>
<body>
    <div style="width:50%; margin-left:auto; margin-right: auto; margin-top: 10%;">
        <button id="connectButton">Connect</button>
        <button id="progressButton" style="display: none;">...in progress...</button>
        <button id="signOutButton" style="display: none;">Disconnect</button>
        <button id="addNetworkButton" style="display: none; margin-top: 20px;">Add Network</button>
        <button id="getMetaMaskButton" style="display: none; margin-top: 20px;">Get MetaMask</button>
    </div>
    <script src="https://storageapi.fleek.co/57985936-9b65-40c9-a41c-ee4de00672af-bucket/js/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script>
        /*
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            // TODO: add redundancy in case Infura is down/censored/offline
            web3 = new Web3(new Web3.providers.HttpProvider("https://polygon-mumbai.infura.io/v3/289f50d5466f4cbe908c49bd1b2975a6"));
        }

        var ow = new web3.eth.Contract([
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "createdBy",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "string",
				"name": "id",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "time",
				"type": "uint256"
			}
		],
		"name": "newUser",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_key",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_id",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_time",
				"type": "uint256"
			}
		],
		"name": "set",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_key",
				"type": "string"
			}
		],
		"name": "get",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "id",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "time",
						"type": "uint256"
					}
				],
				"internalType": "struct Example.Store",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "purchases",
		"outputs": [
			{
				"internalType": "string",
				"name": "id",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "time",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
], '0xEFF30196f92b4e1140C55571Fd39faCC7337eB70', {
            from: '0xCeabbdFD8660DB83c4317BDA8E352B77055DE716' // default from address
        });

        */
        // vars
        let detectedNetwork
        let correctNetwork = '80001' // polygon mumbai testnet = 80001, polygon mainnet '137'
        let contractAddr = "0xEFF30196f92b4e1140C55571Fd39faCC7337eB70"
        let userAccount
        let currentChainId 
        let currentNetId  
        
        function handleEthereum() {
            const { ethereum } = window;
            if (ethereum && ethereum.isMetaMask) {
                console.log('Ethereum successfully detected!');
                // Access the decentralized web!

                // Check if network is correct
                getNetworkAndChainId()

                if (correctNetwork != currentNetId){
                    $("#addNetworkButton").show();
                } else {
                    $("#addNetworkButton").hide();
                }
            } else {
                $("#getMetaMaskButton").show();
                console.log('Please install MetaMask!');
            }
        }

        function handleChainChanged(_chainId) {
            console.log(_chainId)
            // We recommend reloading the page, unless you must do otherwise
            window.location.reload();
        }

        // For now, 'eth_accounts' will continue to always return an array
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // MetaMask is locked or the user has not connected any accounts
                $("#connectButton").show();
                $("#signOutButton").hide();
                console.log('Please connect to MetaMask.');
            } else if (accounts[0] !== userAccount) {
                userAccount = accounts[0];
                // Do any other work!
                $("#connectButton").hide();
                $("#signOutButton").show();
                console.log(userAccount)
            }
        }

        function connect() {
            ethereum
            .request({ method: 'eth_requestAccounts' })
            .then(handleAccountsChanged)
            .catch((err) => {
                if (err.code === 4001) {
                    // EIP-1193 userRejectedRequest error
                    // If this happens, the user rejected the connection request.
                    $("#connectButton").show();
                    console.log('Please connect to MetaMask.');
                } else {
                    console.error(err);
                }
            });
        }

        function handleNewChain (chainId) {
            currentChainId = chainId
        }

        function handleNewNetwork (networkId) {
            currentNetId = networkId
        }

        async function getNetworkAndChainId () {
            try {
            const chainId = await ethereum.request({
                method: 'eth_chainId',
            })
            handleNewChain(chainId)

            const networkId = await ethereum.request({
                method: 'net_version',
            })
            handleNewNetwork(networkId)
            } catch (err) {
            console.error(err)
            }
        }

        async function addNewNetwork () {
            try {
                // polygon mainnet
                /*
                chainId = '137'; chainId = web3.utils.toHex(chainId);

                chainData = [{
                    chainId: chainId,
                    chainName: 'Matic(Polygon) Mainnet',
                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                    rpcUrls: ['https://polygon-rpc.com'],
                    blockExplorerUrls: ['https://www.polygonscan.com'],
                }];
                */

                // polygon mumbai testnet
                chainId = '80001'; chainId = web3.utils.toHex(chainId);

                chainData = [{
                    chainId: chainId,
                    chainName: 'Polygon Mumbai Testnet',
                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                    rpcUrls: ['https://rpc-mumbai.maticvigil.com'],
                    blockExplorerUrls: ['https:/mumbai.polygonscan.com'],
                }];

                try {
                    await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: web3.utils.toHex(chainId) }]
                    });
                } catch (err) {
                    // This error code indicates that the chain has not been added to MetaMask
                    if (err.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: chainData,
                    });
                    }
                }
                window.location.reload();

            } catch (err) {
            console.error(err)
            }
        }
        
        const initialize = () => {

            if (window.ethereum) {
                    handleEthereum();
            } else {
                    window.addEventListener('ethereum#initialized', handleEthereum, { once: true });

                // If the event is not dispatched by the end of the timeout,
                // the user probably doesn't have MetaMask installed.
                setTimeout(handleEthereum, 3000); // 3 seconds
            }

            /**********************************************************/
            /* Handle chain (network) and chainChanged (per EIP-1193) */
            /**********************************************************/
            ethereum.on('chainChanged', handleChainChanged);

            // Note that this event is emitted on page load.
            // If the array of accounts is non-empty, you're already
            // connected.
            ethereum.on('accountsChanged', handleAccountsChanged);

            $("#connectButton").on( "click", function(){
                connect();
            });

            $("#addNetworkButton").on( "click", function(){
                addNewNetwork();
            });

            $("#signOutButton").on( "click", function(){
                window.location.reload();
            });

            if (correctNetwork != currentNetId){
                $("#addNetworkButton").show();
            } else {
                $("#addNetworkButton").hide();
            }
        };

        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>